<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>NCERT Timer Study – Host</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="title">NCERT Timer Study</div>
            <div class="subtitle">Host – Share link, then control rounds with the spacebar.</div>
          </div>
          <div class="pill">
            <span class="pill-dot"></span>
            <span>Host</span>
          </div>
        </div>

        <div class="layout">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Room setup</div>
            </div>

            <div id="setup-view">
              <div class="input-group">
                <label for="host-name">Your name</label>
                <input id="host-name" type="text" placeholder="e.g. Anuj" />
              </div>
              <div class="input-group">
                <label for="grade-select">Class</label>
                <select id="grade-select"></select>
              </div>
              <div class="input-group">
                <label for="subject-select">Subject</label>
                <select id="subject-select"></select>
              </div>
              <div class="input-group">
                <label for="chapter-select">Chapter (optional)</label>
                <select id="chapter-select"></select>
              </div>
              <div class="input-group">
                <label for="rounds">Number of questions (rounds)</label>
                <input id="rounds" type="number" min="1" max="10" value="3" />
              </div>
              <button id="create-room-btn">Create room</button>
              <div class="small-text" style="margin-top: 8px">
                All questions/answers are loaded from this computer. Replace with official NCERT text as
                needed.
              </div>
              <div id="host-error" class="error" style="display: none"></div>
            </div>

            <div id="running-view" style="display: none">
              <div class="question-meta" id="meta-label"></div>
              <div class="source-row" id="source-row" style="display: none">
                <span>Source:</span>
                <a id="source-link" href="#" target="_blank" rel="noreferrer"></a>
              </div>
              <div class="question-body" id="question-text"></div>
              <div class="answer" id="answer-text" style="display: none"></div>

              <div class="hint">
                <div><span class="key">Space</span> after everyone finishes → next question</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Timer & players</div>
            </div>

            <div class="timer"><span id="timer-value">00.0</span></div>
            <div class="status-text" id="status-text">Create a room to begin.</div>

            <div class="badge-row">
              <div class="badge badge-strong">
                Rounds: <span id="rounds-label" class="mono">–</span>
              </div>
              <div class="badge">
                Room: <span id="room-id-label" class="mono">–</span>
              </div>
            </div>

            <div id="link-container" class="link-box" style="display: none">
              <div class="small-text">Share this link with your friends. They join from their browsers.</div>
              <div id="join-url" class="link-url mono"></div>
            </div>

            <div style="margin-top: 12px">
              <div class="panel-title" style="margin-bottom: 6px">Players</div>
              <div id="players-list" class="players-list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const socket = io();

      const setupView = document.getElementById('setup-view');
      const runningView = document.getElementById('running-view');
      const hostError = document.getElementById('host-error');
      const createBtn = document.getElementById('create-room-btn');
      const hostNameInput = document.getElementById('host-name');
      const gradeSelect = document.getElementById('grade-select');
      const subjectSelect = document.getElementById('subject-select');
      const chapterSelect = document.getElementById('chapter-select');
      const roundsInput = document.getElementById('rounds');

      const timerValue = document.getElementById('timer-value');
      const statusText = document.getElementById('status-text');
      const roomIdLabel = document.getElementById('room-id-label');
      const roundsLabel = document.getElementById('rounds-label');
      const linkContainer = document.getElementById('link-container');
      const joinUrlEl = document.getElementById('join-url');
      const playersList = document.getElementById('players-list');

      const metaLabel = document.getElementById('meta-label');
      const sourceRow = document.getElementById('source-row');
      const sourceLink = document.getElementById('source-link');
      const questionText = document.getElementById('question-text');
      const answerText = document.getElementById('answer-text');

      let currentRoomId = null;
      let currentState = 'idle';
      let timerInterval = null;
      let timerStartTime = null;
      let catalog = null;

      function formatTime(ms) {
        if (!ms || ms < 0) return '00.0';
        const s = ms / 1000;
        return s.toFixed(1).padStart(4, '0');
      }

      function startTimerSync(startTime) {
        timerStartTime = startTime;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - timerStartTime;
          timerValue.textContent = formatTime(elapsed);
        }, 60);
      }

      function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
      }

      function renderPlayers(players, finishTimes) {
        playersList.innerHTML = '';
        if (!players || !players.length) {
          playersList.innerHTML = '<span class="small-text">Waiting for players to join…</span>';
          return;
        }
        const times = finishTimes || {};
        players.forEach(p => {
          const row = document.createElement('div');
          row.className = 'player-pill';
          const name = document.createElement('div');
          name.className = 'player-name';
          name.textContent = p.name;
          row.appendChild(name);
          if (times[p.name]) {
            const badge = document.createElement('div');
            badge.className = 'time-badge mono';
            badge.textContent = formatTime(times[p.name]) + ' s';
            row.appendChild(badge);
          }
          playersList.appendChild(row);
        });
      }

      function highlightKeywords(answer, keywords) {
        if (!keywords || !keywords.length) return answer;
        let html = answer;
        keywords.forEach(kw => {
          if (!kw) return;
          const escaped = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp('(' + escaped + ')', 'gi');
          html = html.replace(
            re,
            '<span class="keyword">$1</span>'
          );
        });
        return html;
      }

      function setSource(source) {
        if (!source || !source.url) {
          sourceRow.style.display = 'none';
          sourceLink.textContent = '';
          sourceLink.href = '#';
          return;
        }
        sourceRow.style.display = 'flex';
        sourceLink.textContent = source.label || source.url;
        sourceLink.href = source.url;
      }

      function fillSelect(el, options, { includeBlank = false, blankLabel = 'Select…' } = {}) {
        el.innerHTML = '';
        if (includeBlank) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = blankLabel;
          el.appendChild(opt);
        }
        (options || []).forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          el.appendChild(opt);
        });
      }

      function updateSubjects() {
        if (!catalog) return;
        const gradeKey = gradeSelect.value;
        const subjects = catalog.subjectsByGrade?.[gradeKey] || [];
        fillSelect(subjectSelect, subjects);
        updateChapters();
      }

      function updateChapters() {
        if (!catalog) return;
        const gradeKey = gradeSelect.value;
        const subject = subjectSelect.value;
        const chapters = catalog.chaptersByGradeSubject?.[gradeKey]?.[subject] || [];
        fillSelect(chapterSelect, chapters, {
          includeBlank: true,
          blankLabel: 'All chapters'
        });
      }

      createBtn.addEventListener('click', () => {
        hostError.style.display = 'none';
        if (!gradeSelect.value) {
          hostError.textContent = 'Please select Class.';
          hostError.style.display = 'block';
          return;
        }
        if (!subjectSelect.value) {
          hostError.textContent = 'Please select Subject.';
          hostError.style.display = 'block';
          return;
        }
        socket.emit('createRoom', {
          hostName: hostNameInput.value,
          totalRounds: roundsInput.value,
          grade: gradeSelect.value,
          subject: subjectSelect.value,
          chapter: chapterSelect.value
        });
      });

      gradeSelect.addEventListener('change', updateSubjects);
      subjectSelect.addEventListener('change', updateChapters);

      socket.emit('getQuestionCatalog');
      socket.on('questionCatalog', data => {
        catalog = data;
        fillSelect(gradeSelect, data.grades?.map(String) || []);
        updateSubjects();
      });

      socket.on('roomCreated', data => {
        currentRoomId = data.roomId;
        roomIdLabel.textContent = data.roomId;
        roundsLabel.textContent = data.totalRounds;
        const url =
          data.joinUrl || window.location.origin.replace(/\/host.*/, '') + '/join/' + data.roomId;
        linkContainer.style.display = 'block';
        joinUrlEl.textContent = url;
        statusText.textContent = 'Share the link. Press START when everyone has joined.';

        setupView.innerHTML = '';
        const info = document.createElement('div');
        info.innerHTML =
          '<div class="small-text">Room created. Share the link on WhatsApp / Discord etc.</div>';
        const startBtn = document.createElement('button');
        startBtn.textContent = 'Start practice';
        startBtn.style.marginTop = '12px';
        startBtn.addEventListener('click', () => {
          if (!currentRoomId) return;
          socket.emit('startGame', { roomId: currentRoomId });
        });
        setupView.appendChild(info);
        setupView.appendChild(startBtn);
      });

      socket.on('playerListUpdate', ({ players }) => {
        renderPlayers(players);
      });

      socket.on('joinedRoom', () => {
        // host does not use this, ignore
      });

      socket.on('questionStarted', payload => {
        currentState = 'in_question';
        runningView.style.display = 'block';
        answerText.style.display = 'none';
        metaLabel.textContent = `Q${payload.questionIndex}/${payload.totalRounds} • Class ${payload.grade} • ${payload.subject} • ${payload.chapter}`;
        setSource(payload.source);
        questionText.textContent = payload.question;
        statusText.textContent = 'Question live. Everyone is writing on paper.';
        startTimerSync(payload.startTime);
      });

      socket.on('showAnswer', payload => {
        currentState = 'showing_answer';
        stopTimer();
        timerValue.textContent = '— —';
        statusText.textContent = 'Answer revealed. Review keywords, then space for next question.';
        const meta =
          `Q${payload.questionIndex}/${payload.totalRounds} • Class ${payload.grade} • ${payload.subject} • ${payload.chapter}`;
        metaLabel.textContent = meta;
        setSource(payload.source);
        questionText.textContent = payload.question;
        answerText.style.display = 'block';
        answerText.innerHTML = highlightKeywords(payload.answer, payload.keywords);
        renderPlayers(
          Object.entries(payload.finishTimes).map(([name]) => ({ name })),
          payload.finishTimes
        );
      });

      socket.on('gameOver', ({ totalRounds }) => {
        currentState = 'finished';
        stopTimer();
        timerValue.textContent = '00.0';
        statusText.textContent = `Finished ${totalRounds} rounds. Refresh to host a new room.`;
        metaLabel.textContent = 'Session finished';
        questionText.textContent = '';
        answerText.style.display = 'none';
      });

      socket.on('errorMessage', msg => {
        hostError.textContent = msg;
        hostError.style.display = 'block';
      });

      window.addEventListener('keydown', e => {
        if (e.code === 'Space' || e.key === ' ') {
          if (currentState === 'showing_answer' && currentRoomId) {
            e.preventDefault();
            socket.emit('hostNext', { roomId: currentRoomId });
          }
        }
      });
    </script>
  </body>
</html>


