<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>NCERT Timer Study – Join</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="title">NCERT Timer Study</div>
            <div class="subtitle">Join a friend and race your recall on paper answers.</div>
          </div>
          <div class="pill pill-muted">
            <span class="pill-dot"></span>
            <span>Player</span>
          </div>
        </div>

        <div class="layout">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Question</div>
            </div>

            <div id="join-view">
              <div class="input-group">
                <label for="name-input">Your name</label>
                <input id="name-input" type="text" placeholder="e.g. Priya" />
              </div>
              <button id="join-btn">Join room</button>
              <div id="player-error" class="error" style="display: none"></div>
            </div>

            <div id="question-view" style="display: none">
              <div class="question-meta" id="meta-label"></div>
              <div class="source-row" id="source-row" style="display: none">
                <span>Source:</span>
                <a id="source-link" href="#" target="_blank" rel="noreferrer"></a>
              </div>
              <div class="question-body" id="question-text"></div>
              <div class="answer" id="answer-text" style="display: none"></div>
              <div class="hint">
                <div>
                  Write on paper. Hit <span class="key">Space</span> as soon as you finish. Answer appears
                  when everyone is done.
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Timer & info</div>
            </div>
            <div class="timer"><span id="timer-value">00.0</span></div>
            <div class="status-text" id="status-text">Waiting to join a room…</div>

            <div class="badge-row">
              <div class="badge badge-strong">
                Rounds: <span id="rounds-label" class="mono">–</span>
              </div>
              <div class="badge">
                Room: <span id="room-id-label" class="mono">–</span>
              </div>
            </div>

            <div style="margin-top: 12px">
              <div class="panel-title" style="margin-bottom: 6px">Your status</div>
              <div class="players-list">
                <div class="small-text">
                  This tab only tracks your own spacebar. The host sees everyone’s times together.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const socket = io();

      const joinView = document.getElementById('join-view');
      const questionView = document.getElementById('question-view');
      const nameInput = document.getElementById('name-input');
      const joinBtn = document.getElementById('join-btn');
      const playerError = document.getElementById('player-error');

      const timerValue = document.getElementById('timer-value');
      const statusText = document.getElementById('status-text');
      const roomIdLabel = document.getElementById('room-id-label');
      const roundsLabel = document.getElementById('rounds-label');

      const metaLabel = document.getElementById('meta-label');
      const sourceRow = document.getElementById('source-row');
      const sourceLink = document.getElementById('source-link');
      const questionText = document.getElementById('question-text');
      const answerText = document.getElementById('answer-text');

      let roomId = null;
      let state = 'before_join';
      let doneThisQuestion = false;
      let timerInterval = null;
      let timerStartTime = null;

      function formatTime(ms) {
        if (!ms || ms < 0) return '00.0';
        const s = ms / 1000;
        return s.toFixed(1).padStart(4, '0');
      }

      function startTimerSync(startTime) {
        timerStartTime = startTime;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - timerStartTime;
          timerValue.textContent = formatTime(elapsed);
        }, 60);
      }

      function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
      }

      function highlightKeywords(answer, keywords) {
        if (!keywords || !keywords.length) return answer;
        let html = answer;
        keywords.forEach(kw => {
          if (!kw) return;
          const escaped = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp('(' + escaped + ')', 'gi');
          html = html.replace(
            re,
            '<span class="keyword">$1</span>'
          );
        });
        return html;
      }

      function setSource(source) {
        if (!source || !source.url) {
          sourceRow.style.display = 'none';
          sourceLink.textContent = '';
          sourceLink.href = '#';
          return;
        }
        sourceRow.style.display = 'flex';
        sourceLink.textContent = source.label || source.url;
        sourceLink.href = source.url;
      }

      function getRoomIdFromUrl() {
        const parts = window.location.pathname.split('/');
        return parts[parts.length - 1] || null;
      }

      roomId = getRoomIdFromUrl();
      if (roomId) {
        roomIdLabel.textContent = roomId;
      }

      joinBtn.addEventListener('click', () => {
        playerError.style.display = 'none';
        if (!roomId) {
          playerError.textContent = 'No room ID in URL.';
          playerError.style.display = 'block';
          return;
        }
        socket.emit('joinRoom', {
          roomId,
          name: nameInput.value
        });
      });

      socket.on('joinedRoom', payload => {
        state = 'waiting';
        roundsLabel.textContent = payload.state.totalRounds;
        statusText.textContent = 'Joined. Waiting for host to start.';
        joinView.style.display = 'none';
        questionView.style.display = 'block';
      });

      socket.on('questionStarted', payload => {
        state = 'in_question';
        doneThisQuestion = false;
        answerText.style.display = 'none';
        metaLabel.textContent = `Q${payload.questionIndex}/${payload.totalRounds} • Class ${payload.grade} • ${payload.subject} • ${payload.chapter}`;
        setSource(payload.source);
        questionText.textContent = payload.question;
        statusText.textContent = 'Writing on paper… hit space as soon as you finish.';
        startTimerSync(payload.startTime);
      });

      socket.on('showAnswer', payload => {
        state = 'viewing_answer';
        stopTimer();
        statusText.textContent = 'Answer displayed. Check which keywords you used.';
        const meta =
          `Q${payload.questionIndex}/${payload.totalRounds} • Class ${payload.grade} • ${payload.subject} • ${payload.chapter}`;
        metaLabel.textContent = meta;
        setSource(payload.source);
        questionText.textContent = payload.question;
        answerText.style.display = 'block';
        answerText.innerHTML = highlightKeywords(payload.answer, payload.keywords);
      });

      socket.on('gameOver', ({ totalRounds }) => {
        state = 'finished';
        stopTimer();
        timerValue.textContent = '00.0';
        statusText.textContent = `Finished ${totalRounds} rounds. Ask host to share a new link for the next set.`;
        metaLabel.textContent = 'Session finished';
        questionText.textContent = '';
        answerText.style.display = 'none';
      });

      socket.on('errorMessage', msg => {
        playerError.textContent = msg;
        playerError.style.display = 'block';
      });

      window.addEventListener('keydown', e => {
        if (e.code === 'Space' || e.key === ' ') {
          if (state === 'in_question' && !doneThisQuestion && roomId) {
            e.preventDefault();
            doneThisQuestion = true;
            socket.emit('playerDone', { roomId });
            statusText.textContent = 'Waiting for others to finish…';
          }
        }
      });
    </script>
  </body>
</html>


